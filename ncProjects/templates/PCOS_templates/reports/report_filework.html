<!{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="{% static 'css/pcos_style_db.css' %}" /> 
    <script type="text/javascript" charset="utf8" src="{% static 'datatables/jquery-3.5.1.js' %}"></script>
    <title>Обработка файла</title>
    <script src="https://www.papaparse.com/resources/js/papaparse.js"></script>
</head>
<body>       
       <p> Обработка файла </p>   
       <p> <input type="file" id="csv-file" name="files" style="width:115px; height: 23px"/></p><br>
       <p> <textarea id="sfield" style="width:100%;height:40%"></textarea></p><br>
       <p> <button type="button" id="sf" style="width:115px; height: 23px">Сохранить</button></p>
<script>  

document.getElementById('sf').addEventListener('click', () => {
    textToFile (document.getElementById('sfield').value, 'file.txt')
})
function textToFile (text, name) {
    const b = new Blob([text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = url;
    a.download = name || 'text.txt';
    a.type = 'text/plain';
    a.addEventListener('click', () => {
        setTimeout(() => window.URL.revokeObjectURL(url), 10000);
    })
    a.click()
}
 

function printPapaObject(papa) 
{

s_text=''
for (var i = 0; i < papa.data.length; i++) 
 { 
    result=papa.data[i]

    ethnicity_                  =result['ethnicity']
        periods_                        =result['periods']
        type_menstrual_disorders_1_=result['type_menstrual_disorders___1']
        type_menstrual_disorders_2_=result['type_menstrual_disorders___2']
        type_menstrual_disorders_3_=result['type_menstrual_disorders___3']
        type_menstrual_disorders_4_=result['type_menstrual_disorders___4']
    
        if (isNaN(result['min_menstrual'])) {min_menstrual_ =null} 
        else {min_menstrual_                =Number(result['min_menstrual'])}

        if (isNaN(result['max_menstrual'])) {max_menstrual_=null} else 
        {max_menstrual_             =Number(result['max_menstrual'])}           
        

        if (isNaN(result['sum_physician'])) {sum_physician_=null} else 
        {sum_physician_             =Number(result['sum_physician'])}   

        

        

        if (isNaN(result['right_volume_total'])) {right_volume_total_=null} else 
        {right_volume_total_            =Number(result['right_volume_total'])}              
        

        if (isNaN(result['right_follicle_total'])) {right_follicle_total_=null} else 
        {right_follicle_total_      =Number(result['right_follicle_total'])}    
        

        if (isNaN(result['diameter_right_total'])) {diameter_right_total_=null} else 
        {diameter_right_total_      =Number(result['diameter_right_total'])}    
        

        if (isNaN(result['left_volume_total'])) {left_volume_total_=null} else 
        {left_volume_total_         =Number(result['left_volume_total'])}   
        

        if (isNaN(result['left_follicle_total'])) {left_follicle_total_=null} else 
        {left_follicle_total_       =Number(result['left_follicle_total'])} 
        

        if (isNaN(result['diameter_left_total'])) {diameter_left_total_=null} else 
        {diameter_left_total_       =Number(result['diameter_left_total'])} 
        
        
        if (isNaN(result['value_testosteron'])) {value_testosteron_=null} else 
        {value_testosteron_ =Number(result['value_testosteron'])}           
        

        if (isNaN(result['value_shbg'])) {value_shbg_=null} else 
        {value_shbg_                    =Number(result['value_shbg'])}  
        

        if (isNaN(result['value_dheas'])) {value_dheas_=null} else 
        {value_dheas_               =Number(result['value_dheas'])} 
        

        if (isNaN(result['value_tsh'])) {value_tsh_=null} else 
        {value_tsh_                 =Number(result['value_tsh'])}
        
        if (isNaN(result['day_mens_prl'])) {day_mens_prl_=NaN} else 
        {day_mens_prl_              =Number(result['day_mens_prl'])}    
        

        if (isNaN(result['value_17hp'])) {value_17hp_   =null} else 
        {value_17hp_                    =Number(result['value_17hp'])}  
        

        if (isNaN(result['value_prl'])) {value_prl_=NaN} else 
        {value_prl_                 =Number(result['value_prl'])}   
        
        
        value_dheas_max_                =355
        value_tsh_min_                  =0.1
        value_tsh_max_                  =4  
        value_17hp_max_1_               =6.9
        value_prl_max_1_                =726
        value_prl_max_2_                =944
        

        age_visit1_                 =result['age_visit1']
        inform_consent_         =result['inform_consent']
        comply_all_study_       =result['comply_all_study']
        female_age_                 =result['female_age']
        current_preg_lact_      =result['current_preg_lact'] 
        history_hysterectomy_   =result['history_hysterectomy']
        risk_no_compliance_     =result['risk_no_compliance']
        unwillingness_              =result['unwillingness']
        medicince_listed_now___10_   =result['medicince_listed_now___10']
        medicince_listed_3month___10_=result['medicince_listed_3month___10']
        pnya_                               ='0'

        
        OA=null     
        PCOM=null    
        H=null   
        included=0
        
        if (inform_consent_!=null && comply_all_study_!=null && female_age_!=null && current_preg_lact_!=null && history_hysterectomy_!=null && risk_no_compliance_!=null && unwillingness_!=null && medicince_listed_now___10_!=null && medicince_listed_3month___10_!=null)
        {
            if (inform_consent_=='1' && comply_all_study_=='1' && female_age_=='1' && current_preg_lact_=='0' && history_hysterectomy_=='0' && risk_no_compliance_=='0' && unwillingness_=='0' && medicince_listed_now___10_=='1' && medicince_listed_3month___10_=='1')
                {included=1 }
        }
        
        if (included==1) 
        {
            if (periods_!=null)
            { 
                if (periods_=='2' || periods_=='3') 
                {
                    if (type_menstrual_disorders_1_=='1' || type_menstrual_disorders_2_=='1' ||
                      type_menstrual_disorders_3_=='1' || type_menstrual_disorders_4_=='1')
                    {
                        OA=1
                    }
                }
            }
            if (min_menstrual_!=null)
            {
                if (min_menstrual_<21) 
                {
                    OA=1
                } 
            }
            if (max_menstrual_!=null)
            {
                if (max_menstrual_>35) 
                {
                    OA=1
                } 
            }
            if (periods_!=null)
            {
                if (periods_=='1') 
                {
                    if (type_menstrual_disorders_1_==0 &&  type_menstrual_disorders_2_==0 &&  type_menstrual_disorders_3_==0 && type_menstrual_disorders_4_==0)
                    {
                        if (min_menstrual_!=null)
                        {
                            if (min_menstrual_>=21) 
                            {
                                if (max_menstrual_!=null)
                                {
                                    if (max_menstrual_<=35) 
                                    {
                                        OA=0
                                    } 
                                }
                            } 
                        }
                    }
            
                }
            }
            
            //***************************************************
            PCOM_right=991
            PCOM_left=991
            right_volume_total=0
            right_follicle_total=0
            diameter_right_total=0

            if (right_volume_total_!=null)
            {
            right_volume_total=right_volume_total_
            }

            if (right_follicle_total_!=null)
            {
            right_follicle_total=right_follicle_total_
            }

            if (diameter_right_total_!=null)
            {
            diameter_right_total=diameter_right_total_
            }

            if (diameter_right_total!=null)
            {
                if (right_volume_total>=10 || right_follicle_total>=12) 
                {
                    if (diameter_right_total<=9) 
                    {   
                        PCOM_right=1
                    }
                    else
                    {   
                    PCOM_right=991
                  }
                }
            }
            
            if (right_volume_total!=null && right_follicle_total==null)
            {
            add_text="ошибка right 1"
            }
            if (right_volume_total==null && right_follicle_total!=null)
            {
            add_text="ошибка right 1" 
            }
            if (right_volume_total==null  && right_follicle_total==null && diameter_right_total!=null)
            {
                add_text="ошибка right 3"
            } 

            left_volume_total=0
            left_follicle_total=0
            diameter_left_total=0

            if (left_volume_total_!=null)
            {
            left_volume_total=left_volume_total_
            }
            if (left_follicle_total_!=null)
            {
            left_follicle_total=left_follicle_total_
            }
            if (diameter_left_total_!=null)
            {
            diameter_left_total=diameter_left_total_
            }

            if (diameter_left_total!=null)
            {
                if (left_volume_total>=10 || left_follicle_total>=12) 
                {
                    if (diameter_left_total<=9) 
                    {   
                        PCOM_left=1
                    }
                    else
                    {   
                    PCOM_left=991
                  }
                }
            }
            
            if (left_volume_total!=null && left_follicle_total==null)
            {
            add_text="ошибка left 1"
            }
            if (left_volume_total==null && left_follicle_total!=null)
            {
            add_text="ошибка left 2" 
            }
            if (left_volume_total==null && left_follicle_total==null && diameter_left_total!=null)
            {
            add_text="ошибка left 3" 
            }
            if (PCOM_right==1 || PCOM_left==1)
            {
                PCOM=1
            }   
            if (right_volume_total!=null && right_follicle_total!=null && diameter_right_total!=null)
            {
                if (right_volume_total<10 && right_follicle_total<12) 
                {
                    if (diameter_right_total<=9) 
                    {   
                        PCOM_right=0
                    }
                if (diameter_right_total>9) 
                {   
                    PCOM_right=991
                }
                }
            }
            if (left_volume_total!=null && left_follicle_total!=null && diameter_left_total!=null)
            {
                if (left_volume_total<10 && left_follicle_total<12) 
                {
                    if (diameter_left_total<=9) 
                    {   
                        PCOM_left=0
                    }
                if (diameter_left_total>9) 
                {   
                    PCOM_left=991
                }
                }
            }
            if ((PCOM_right==0 && PCOM_left==0) || (PCOM_right==991 && PCOM_left==0) || (PCOM_right==0 &&PCOM_left==991))
            {
            PCOM=0
            }   
        
            //************************************************************************************
            if (ethnicity_==null)           
            {
                krit_testosteron=67.34
                krit_IFA=5.42
            }
            else
            {
                race=ethnicity_
                if (race==1)
                {
                    krit_testosteron=73.9
                    krit_IFA=6.9
                }
                if (race==2||race==3)
                {
                    krit_testosteron=41.03
                    krit_IFA=2.92
                }
            }

            //krit_testosteron=value_testosteron_max_
            //krit_IFA=value_IFA_max_
            
        H_sum_ph=null
        H_test=null
        H_IFA=null
        H_dheas=null
        
            if (sum_physician_!=null)           
            {
                sum_physician=sum_physician_
                if (sum_physician>4)
                {
                    H=1 
                    H_sum_ph=1
                }
                if (sum_physician<=4)
                {
                  H_sum_ph=0
                }
            }
            testosteron=0
            testosteron_ng_dl=null
            IFA=null
            if (value_testosteron_!=null)           
            {
                testosteron=value_testosteron_/1000*3.467
                testosteron_ng_dl=value_testosteron_/10
                if (testosteron_ng_dl>krit_testosteron)
                {
                    H=1 
                    
                    H_test=1
                }
                if (testosteron_ng_dl<=krit_testosteron)
                {
                  H_test=0
                }
            }
            else
            {
                testosteron=null
            }
            if (value_shbg_!=null && testosteron>0)
            {
                IFA=testosteron/value_shbg_*100
                if (IFA>krit_IFA)
                {
                    H=1 
                    H_IFA=1
                }
                if (IFA<=krit_IFA)
                {
                
                  H_IFA=0
                }
            }
            else
            {
                IFA=null
            }
            
            value_dheas=0
            if (value_dheas_!=null)         
            {
                value_dheas=value_dheas_
                if (value_dheas>value_dheas_max_)
                {
                    H=1 
                    H_dheas=1
                }
                if (value_dheas<=value_dheas_max_)
                {
                  H_dheas=0
                }
            }
        
            if (sum_physician_!=null && testosteron_ng_dl!=null && IFA!=null && value_dheas_!=null)
            {
                if (sum_physician<=4 && testosteron_ng_dl<=krit_testosteron && IFA<=krit_IFA && value_dheas<=value_dheas_max_)
                    {
                        H=0
                    }
            }
            
            
            //****************************************************

            PH=null
            PCOS=null
            if (OA!=null && H!=null && PCOM!=null)
            {
                if (OA==1 && H==1 && PCOM==1)
                {
                    PH="A"
                }
                if (OA==1 && H==1 && PCOM==0)
                {
                    PH="B"
                }
                if (OA==0 && H==1 && PCOM==1)
                {
                    PH="C"
                }
                if (OA==1 && H==0 && PCOM==1)
                {
                    PH="D"
                }
                if (OA==0 && H==0 && PCOM==0)
                {
                    PCOS=0
                }
            }

            if (OA==null) {OA__=0} else {OA__=OA}
            if (H==null)  {H__=0}  else {H__=H}
            if (PCOM==null) {PCOM__=0} else { if (PCOM==1) {PCOM__=1} else {PCOM__=0}}
            if (OA__+H__+PCOM__==2 && PH==null) {PH=0}
            if (PH!=null)
            {
                PCOS=1
            }
            
            //data1[i,"Phenotype"]=PH
            //data1[i,"PCOS"]=PCOS
            //*****************************************************
         
        
            F_PCOS=null
            F_Phenotype=null
            ex_prl=null
            ex_tsh=null
            ex_17ph=null
            ex_pnya=null
            ex=null
            grey=0
            if (value_tsh_!=null)   
            {
            
                tsh=value_tsh_
                if (tsh>value_tsh_max_ || tsh<value_tsh_min_)
                {
                    ex_tsh=1 
                }
                if (tsh>=value_tsh_min_ && tsh<=value_tsh_max_)
                {
                ex_tsh=0 
                }
            }

            ex_pnya=0
            if (pnya_!=null)    
            {
                pnya=pnya_
                if (pnya==true)
                {
                    ex_pnya=1 
                }
                if (pnya==false)
                {
                    ex_pnya=0 
                }
            }
        
    
            if (day_mens_prl_!=null && value_17hp_!=null && value_prl_!=null)
            {
                if (day_mens_prl_<=9)
                {   
                if (value_17hp_>value_17hp_max_1_   )
                {
                    ex_17ph=1
                }  
              if (value_17hp_<= value_17hp_max_1_   )
                {
                    ex_17ph=0
                }  
                if (value_prl_> value_prl_max_1_)
                {
                    ex_prl=1
                    c_1=1
                }  
                if (value_prl_<=    value_prl_max_1_)
                {
                    ex_prl=0
                }  
                }

            if (day_mens_prl_>9)
            {
                ex_17ph=0
            }
            if (day_mens_prl_>9 && day_mens_prl_<=35)
            {

                if (value_prl_>value_prl_max_2_ )
                {
                ex_prl=1

            
                }  
                if (value_prl_<=value_prl_max_2_    )
                {
                ex_prl=0
                }  
            }
            if (day_mens_prl_>35)
            {
                if (value_prl_> value_prl_max_1_)
                {
                ex_prl=1
                e_1=1
                }  
                if (value_prl_<=    value_prl_max_1_)
                {
                ex_prl=0
                }  
            }
            }

            if (isNaN(day_mens_prl_) && value_prl_!=null)
            {
            ex_17ph=0
            if (value_prl_> value_prl_max_1_)
            {
                ex_prl=1
             f_1=1
            }  
            if (value_prl_<=    value_prl_max_1_)
            {
                ex_prl=0
            }  
            }
            
            if (ex_pnya!=null)
            {
                if (ex_pnya==1)
              {
                ex=1
              }
            }  

            if (ex_tsh!=null)
            {
            if (ex_tsh==1)
            {
                ex=1
            }
            }  
            if (ex_17ph!=null)
            {
            if (ex_17ph==1)
            {
                ex=1
            } 
            }  
            if (ex_prl!=null)
            {
            if (ex_prl==1)
            {
                ex=1
            } 
            }  

            if (ex_tsh!=null && ex_17ph!=null && ex_prl!=null && ex_pnya!=null)
            {
            if (ex_tsh==0 && ex_17ph==0 && ex_prl==0 && ex_pnya==0)
            {
                ex=0
            }
            }
          if (ex!=null)
          {
              if (ex==1)
              {
                  F_PCOS=null
                  F_Phenotype=null
              }
              if (ex==0)
              {
                F_PCOS=PCOS
                  F_Phenotype=PH
              }
          }
          else
          {
              F_PCOS=null
              F_Phenotype=null
          }
           
            
        
            if (OA__+H__+PCOM__==1)
            {   
                grey=1
                F_PCOS=0    
            }
        
            PCOS_text="Дата начала диспансерного наблюдения  "
        if (F_PCOS==1)
        {   
            PCOS_text=PCOS_text+"Заключительный (уточненный) диагноз: синдром поликистоза яичников (МКБ:Е28.2). "
            if (F_Phenotype!=null && F_Phenotype!=0)
            {
                PCOS_text=PCOS_text+"Фенотип СПКЯ (согласно критериям Rotterdam 2003): "+F_Phenotype+". "
                if (OA==1)
                {   
                    PCOS_text=PCOS_text+"Олигоановуляция. "
                }
                
                if (PCOM==1)
                {
                    PCOS_text=PCOS_text+"Поликистозная структура яичников или УЗИ-признаки поликистозных яичников (ПКЯ). "
                    if (PCOM_right==1)
                    {  
                        PCOS_text=PCOS_text+"(Количество антральных фолликулов в правом яичнике: "+ right_follicle_total+" объем правого яичника: "+right_volume_total +"). "
                    }
                    if (PCOM_left==1)
                    {  
                        PCOS_text=PCOS_text+"(Количество антральных фолликулов в левом яичнике "+ left_follicle_total+" объем левого яичника: "+ left_volume_total+"). "
                    }
                }
                if (H==1)
                {
                    PCOS_text=PCOS_text+"Гиперандрогенизм. "
                }
            }
        }
                if (F_PCOS==0)
        {   
            if (grey==0)
            {
                PCOS_text=PCOS_text+"Заключительный (уточненный) диагноз: синдром поликистоза яичников не подтвержден. "
            }
            if (grey==1)
            {
                PCOS_text=PCOS_text+"Заключительный (уточненный) диагноз: синдром поликистоза яичников не подтвержден_ при этом присутствуют: "
                if (OA==1)
                {
                    PCOS_text=PCOS_text+"олигоановуляция; "
                }
                if (PCOM==1)
                {
                    PCOS_text=PCOS_text+"поликистозная структура яичников или УЗИ-признаки поликистозных яичников (ПКЯ); "
                }
                if (H==1)
                {
                    PCOS_text=PCOS_text+"гиперандрогенизм: "
                    if (H_sum_ph==1)
                    {
                        PCOS_text=PCOS_text+"гирсутизм; "
                    }
                    if (H_test==1 || H_IFA==1 || H_dheas==1)
                    {
                        PCOS_text=PCOS_text+"избыток андрогенов ("
                        
                        if (H_test==1)
                        {
                            PCOS_text=PCOS_text+"уровень тестостерона"
                            if (H_IFA==1 || H_dheas==1)
                            {
                                PCOS_text=PCOS_text+"_ "
                            }
                        }
                        if (H_IFA==1)
                        {
                            PCOS_text=PCOS_text+"индексы свободных андрогенов"
                            if (H_dheas==1)
                            {
                                PCOS_text=PCOS_text+"_ "
                            }

                        }
                        if (H_dheas==1)
                        {
                            PCOS_text=PCOS_text+"ДГЭАС "
                        }
                        PCOS_text=PCOS_text+") выше нормативных значений. "
                    }   
                }

            }
    
            //if (grey==null)
            //{
            //      PCOS_text=PCOS_text+"Заключительный (уточненный) диагноз: синдром поликистоза яичников //не подтвержден; при этом недостаточно данных для диагностики 'серой зоны': "+OA+H+PCOM
            //  if (OA==null)
            //  {
            //      PCOS_text=PCOS_text+"нет данных по OA; "
            //  }
            //  if (PCOM==null)
            //  {
            //      PCOS_text=PCOS_text+"нет данных по УЗИ; "
            //  }
            //  if (H==null)
            //  {
            //      PCOS_text=PCOS_text+"нет данных по лабораторным исследованиям; "
            //  }


            //}
        }
        //*************************************************************

        if (F_PCOS==null && ex==null)
        {
            
            PCOS_text=PCOS_text+"Недостаточно данных для диагностики СПКЯ. Требуется дообследование "

            if (ex_prl==null)
            {
                PCOS_text=PCOS_text+"(пролактин?); "
            }   
            if (ex_tsh==null)
            {
                PCOS_text=PCOS_text+"(ТТГ?); "
            }   
            if (ex_17ph==null)
            {
                PCOS_text=PCOS_text+"(17-OH прогестерон?); "
            }   
            if (ex_pnya==null)
            {
                PCOS_text=PCOS_text+"(отсутствуют данные о преждевременной недостаточности яичников); "
            }   
            
        }

        if (F_PCOS==null && ex==1)
        {
            if (ex_prl==1)
            {
                PCOS_text=PCOS_text+"Повышенный пролактин (гиперпролактинемия (Е22.1) ?) ("+value_prl_+"). "
            }   
            if (ex_tsh==1)
            {
                PCOS_text=PCOS_text+"Повышение ТТГ (тиреотоксикоз (гипертиреоз) Е05 ?)("+tsh+"). "
            }   
            if (ex_17ph==1)
            {
                PCOS_text=PCOS_text+"Повышение 17-OH прогестерона("+value_17hp_+"). "
            }   
            if (ex_pnya==1)
            {
                PCOS_text=PCOS_text+"Преждевременная недостаточность яичников."
            }   
        }
            s_text=s_text+'\n'+ PCOS_text+','+result['id']+','+F_PCOS+','+F_Phenotype+','+ex+','+grey+','+OA+','+PCOM+','+H+','+included+','+ex_prl+','+ex_17ph+','+ex_tsh+','+H_dheas+','+H_IFA+','+H_test+','+H_sum_ph

    }   //included=1
    else
    {
            F_PCOS=null
            ex=null
            grey=null
            F_Phenotype=null
            s_text=s_text+'\n'+'Пациент не удовлетворяет критериям включения в процедуру диагностики СПКЯ'

    }//included=0
    
    }
     var element=document.getElementById('sfield')
    element.innerHTML='PCOS_text,id,F_PCOS,F_Phenotype,ex,grey,OA,PCOM,H,included,ex_prl,ex_17ph,ex_tsh,H_dheas,H_IFA,H_test,H_sum_ph'
    
     element.innerHTML += s_text;

 
  

 }

function handleFileSelect(evt) {
  var file = evt.target.files[0];
  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      printPapaObject(results);
    }
  });
}
$(document).ready(function() {
  $("#csv-file").change(handleFileSelect);
});
</script>
    </body>

</html>